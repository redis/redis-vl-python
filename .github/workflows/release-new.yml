name: Publish Release

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"
  UV_VERSION: "0.7.13"
  AUTO_VERSION: "11.3.6"

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}   # sets UV_PYTHON
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Build package
        run: uv build

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download and install auto
        run: |
          curl -L https://github.com/intuit/auto/releases/download/v${{ env.AUTO_VERSION }}/auto-linux.gz -o auto-linux.gz
          gunzip auto-linux.gz
          chmod +x auto-linux
          sudo mv auto-linux /usr/local/bin/auto
          auto --version

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          auto create-labels
          auto shipit -v --dry-run

  publish:
    needs: release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}   # sets UV_PYTHON
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI }}
        run: uv publish