name: Publish Release

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"
  UV_VERSION: "0.7.13"
  AUTO_VERSION: "11.3.6"

jobs:
  canary-build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'auto:release')

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}   # sets UV_PYTHON
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Check that package can be built
        run: uv build

  release:
    needs: canary-build
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'auto:release')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download and install auto
        run: |
          curl -L https://github.com/intuit/auto/releases/download/v${{ env.AUTO_VERSION }}/auto-linux.gz -o auto-linux.gz
          gunzip auto-linux.gz
          chmod +x auto-linux
          sudo mv auto-linux /usr/local/bin/auto
          auto --version

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          auto create-labels
          auto shipit -v --dry-run

  build-and-publish:
    needs: release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'auto:release')

    steps:
      - name: Check out repository
        uses: actions/checkout@v6

      - name: Install Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
          python-version: ${{ env.PYTHON_VERSION }}   # sets UV_PYTHON
          cache-dependency-glob: |
            pyproject.toml
            uv.lock

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Get latest release version
        id: latest_release
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const version = release.data.tag_name.replace(/^v/, "");
            core.setOutput("version", version);

      - name: Apply release version to pyproject.toml
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          sed -i "s/^version = \".*\"$/version = \"${VERSION}\"/" pyproject.toml
          grep '^version = ' pyproject.toml

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI }}
        run: echo "uv publish"  # TODO: call uv publish when ready
